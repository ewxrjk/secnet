
VPATH:=@srcdir@
srcdir:=@srcdir@
topdir:=@top_srcdir@

TARGETS += udp-preload.so

DEPS += udp-preload.so
DEPS += $(srcdir)/common.tcl
DEPS += ../secnet
DEPS += ../test-example/sites.conf

include ../test-common.make

CFLAGS += -D_REENTRANT -fPIC

udp-preload.so: udp-preload.o
	$(CC) -shared -Wl,-soname,$@.1 $^ -o $@ -ldl

# These test scripts use little cpu but contain sleeps etc.  So when
# there are several, we are going to want to run *loads* in parallel.
#
# Ideally we would do something like "every one of these counts for a
# tenth of a job" but make can't do that.  So bodge it: we treat all the
# tests as a single job, and disconnect the parent's jobserver.
#
# make.info says $(MAKE) causes special handling of the rule but only
# if it's written literally like that in the rule, hence this
# indirection.  We need no squash MAKEFLAGS and MFLAGS too.
# MAKELEVEL seems like it will be fine to pass on.

MAKE_NOTSPECIAL:=$(MAKE)

check:
	env -u MAKEFLAGS -u MFLAGS \
	$(MAKE_NOTSPECIAL) -j$(shell nproc || 1)0 check-real
