
include ../common.make

TESTSCRIPTS ?= $(shell echo $(srcdir)/t-*[0-9a-z])
TESTNAMES := $(patsubst t-%,%,$(notdir $(TESTSCRIPTS)))

DEPS += $(topdir)/test-common.tcl
DEPS += $(topdir)/common.make
DEPS += $(topdir)/test-common.make
DEPS += Makefile

TARGETS += check

export PYTHONBYTECODEBASE=/dev/null

all: $(TARGETS)

check-real: $(foreach t,$(TESTNAMES),d-$t/ok)

d-%/ok: $(srcdir)/t-% $(DEPS)
	@rm -rf d-$*; mkdir d-$*
	@export SECNET_TEST_BUILDDIR=$(topbuilddir); \
	 cd $(topdir) && \
	 $(TESTDIR)/t-$* >$(topbuilddir)/$(TESTDIR)/d-$*/log 2>&1
	@printf "$* "
	@touch $@

clean:
	$(RM) -f *.o *.so
	$(RM) -rf tmp
	$(RM) -rf d-*
