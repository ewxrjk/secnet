# Makefile for secnet
# Copyright (C) 1995-2001 Stephen Early <steve@greenend.org.uk>

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

.PHONY:	all clean realclean distclean dist install

PACKAGE:=secnet
VERSION:=0.3.4

@SET_MAKE@

srcdir:=@srcdir@
VPATH:=@srcdir@

SHELL:=/bin/sh
RM:=@RM@
CC:=@CC@
INSTALL:=@INSTALL@
INSTALL_PROGRAM:=@INSTALL_PROGRAM@

CFLAGS:=-Wall @WRITESTRINGS@ @CFLAGS@ -Werror \
	-W -Wno-unused -Wno-unused-parameter \
	-Wno-pointer-sign -Wstrict-prototypes -Wmissing-prototypes \
	-Wmissing-declarations -Wnested-externs -Wredundant-decls \
	-Wpointer-arith -Wformat=2 -Winit-self \
	-Wswitch-enum -Wunused-variable -Wunused-function -Wbad-function-cast \
	-Wno-strict-aliasing -fno-strict-aliasing \
	-MMD
ALL_CFLAGS:=@DEFS@ -I$(srcdir) -I. $(CFLAGS) $(EXTRA_CFLAGS)
CPPFLAGS:=@CPPFLAGS@ $(EXTRA_CPPFLAGS)
LDFLAGS:=@LDFLAGS@ $(EXTRA_LDFLAGS)
LDLIBS:=@LIBS@ $(EXTRA_LDLIBS)

prefix:=@prefix@
exec_prefix:=@exec_prefix@
sbindir:=@sbindir@
sysconfdir:=@sysconfdir@
transform:=@program_transform_name@
mandir:=@mandir@

TARGETS:=secnet

OBJECTS:=secnet.o util.o conffile.yy.o conffile.tab.o conffile.o modules.o \
	resolver.o random.o udp.o site.o transform-cbcmac.o transform-eax.o \
	netlink.o rsa.o dh.o serpent.o serpentbe.o \
	md5.o sha512.o tun.o slip.o sha1.o ipaddr.o log.o \
	process.o @LIBOBJS@ \
	hackypar.o
# version.o is handled specially below and in the link rule for secnet.

TEST_OBJECTS:=eax-aes-test.o eax-serpent-test.o eax-serpentbe-test.o \
		eax-test.o aes.o

ifeq (version.o,$(MAKECMDGOALS))
OBJECTS:=version.o
TEST_OBJECTS:=
endif

%.c:	%.y

%.yy.c:	%.fl
	flex --header=$*.yy.h -o$@ $<

%.tab.c %.tab.h:	%.y
	bison -d -o $@ $<

%.o: %.c
	$(CC) $(CPPFLAGS) $(ALL_CFLAGS) -c $< -o $@

all:	$(TARGETS) check

# Automatic remaking of configuration files, from autoconf documentation
${srcdir}/configure: configure.in
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck
# End of config file remaking rules

# C and header file dependency rules
SOURCES:=$(OBJECTS:.o=.c) $(TEST_OBJECTS:.o=.c)
DEPENDS:=$(OBJECTS:.o=.d) $(TEST_OBJECTS:.o=.d)

-include *.d

# Manual dependencies section
conffile.yy.c:	conffile.fl conffile.tab.c
conffile.yy.h:	conffile.yy.c
conffile.tab.c:	conffile.y
# End of manual dependencies section

secnet:	$(OBJECTS)
	$(MAKE) version.o # *.o $(filter-out %.o, $^)
	$(CC) $(LDFLAGS) $(ALL_CFLAGS) -o $@ $(OBJECTS) version.o $(LDLIBS)
# We (always) regenerate the version, but only if we regenerate the
# binary.  (This is necessary as the version string is can depend on
# any of the source files, eg to see whether "+" is needed.)

ifneq (,$(wildcard .git/HEAD))
# If we have (eg) committed, relink and thus regenerate the version
# with the new info from git describe.
secnet: Makefile .git/HEAD $(shell sed -n 's#^ref: #.git/#p' .git/HEAD)
secnet: $(wildcard .git/packed-refs)
endif

check: eax-aes-test.confirm eax-serpent-test.confirm \
	eax-serpentbe-test.confirm check-ipaddrset

version.c: Makefile
	echo "#include \"secnet.h\"" >$@.new
	@set -ex; if test -e .git; then \
		v=$$(git describe --match 'v*'); v=$${v#v}; \
		if ! git diff --quiet HEAD; then v="$$v+"; fi; \
	else \
		v="$(VERSION)"; \
	fi; \
	echo "char version[]=\"secnet $$v\";" >>$@.new
	mv -f $@.new $@

eax-%-test: eax-%-test.o eax-test.o %.o
	$(CC) $(LDFLAGS) $(ALL_CFLAGS) -o $@ $^

eax-%-test.confirm: eax-%-test eax-%-test.vectors
	./$< <$(srcdir)/eax-$*-test.vectors >$@.new
	mv -f $@.new $@

check-ipaddrset: ipaddrset-test.py ipaddrset.py ipaddrset-test.expected
	$(srcdir)/ipaddrset-test.py >ipaddrset-test.new
	diff -u ipaddrset-test.expected ipaddrset-test.new

.PRECIOUS: eax-%-test

installdirs:
	$(INSTALL) -d $(prefix)/share/secnet $(sbindir)
	$(INSTALL) -d $(mandir)/man8

install: installdirs
	$(INSTALL_PROGRAM) secnet $(sbindir)/`echo secnet|sed '$(transform)'`
	$(INSTALL_PROGRAM) ${srcdir}/make-secnet-sites $(sbindir)/`echo make-secnet-sites|sed '$(transform)'`
	$(INSTALL) ${srcdir}/ipaddr.py $(prefix)/share/secnet/ipaddr.py
	$(INSTALL) ${srcdir}/ipaddrset.py $(prefix)/share/secnet/ipaddrset.py
	$(INSTALL) secnet.8 $(mandir)/man8/secnet.8

clean:
	$(RM) -f *.o *.yy.c *.tab.[ch] $(TARGETS) core version.c
	$(RM) -f *.d *~ eax-*-test.confirm eax-*-test

realclean:	clean
	$(RM) -f *~ Makefile config.h  *.d \
	config.log config.status config.cache \
	stamp-h Makefile.bak

distclean:	realclean

pfname:=$(PACKAGE)-$(VERSION)
tarfname:=../$(pfname).tar
dist:
	$(RM) -rf $(tarfname) $(tarfname).gz
	git archive --format=tar --prefix=$(pfname)/ HEAD -o $(tarfname)
	gzip -9f $(tarfname)

# Release checklist:
#  1. Check that the tree has what you want
#
#  2. Update VERSION (above) and debian/changelog
#     but DO NOT COMMIT
#
#  3. Run
#       ./configure
#       make dist
#     and check that the resulting tarball looks OK.
#     Eg, untar it and build it, or have it reviewed.
#
#  3. Commit the updates to VERSION (above) and debian/changelog
#
#  4. git-tag -m "secnet $VERSION" -s v$VERSION
#
#  5. git-push origin v$VERSION v${VERSION}~0:master
#
#  6. Run, again,
#       make dist
#
#  7. gpg --detach-sign ../secnet-$VERSION.tar.gz
#
#  8. rsync -v ../secnet-$VERSION.tar.gz* \
#        chiark:/home/ianmdlvl/public-html/secnet/download/
#
#  9. On chiark:
#       tar zxf ~ianmdlvl/public-html/secnet/download/secnet-$VERSION.tar.gz
#       cd secnet-$VERSION
#       debian/rules build
#       fakeroot debian/rules binary
#       mv ../secnet_${VERSION}_i386.deb ~ianmdlvl/public-html/secnet/download/
#
#  10. On chiark as user secnet:
#       cd ~secnet/public-html/release/
#       mkdir $VERSION
#       cd $VERSION
#       ln -s /home/ianmdlvl/public-html/secnet/download/secnet?$VERSION* .
#
#  11. write and post a release announcement
